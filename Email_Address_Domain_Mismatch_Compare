WITH CTE1
(
	EMAIL_USER
	, EMAIL_DOMAIN
)
AS 
(
	SELECT
	LEFT(MAIL, LEN(MAIL) - (LEN(MAIL) - CHARINDEX('@', MAIL)))
	, RIGHT(MAIL, LEN(MAIL) - CHARINDEX('@', MAIL))
	FROM
	USERS_TABLE WITH(NOLOCK)
),
CTE2
(
	EMAIL_USER
	, EMAIL_DOMAIN
)
AS 
(
	SELECT
	LEFT(MAIL, LEN(MAIL) - (LEN(MAIL) - CHARINDEX('@', MAIL)))
	, RIGHT(MAIL, LEN(MAIL) - CHARINDEX('@', MAIL))
	FROM
	USERS_TABLE WITH(NOLOCK)
)
SELECT 
CTE1.EMAIL_USER	AS ORIGINAL_USER
, CTE1.EMAIL_DOMAIN AS ORIGINAL_DOMAIN
, CTE2.EMAIL_USER AS MATCHING_USER
, CTE2.EMAIL_DOMAIN AS NON_MATCHING_DOMAIN
FROM 
CTE1 INNER JOIN CTE2
ON CTE1.EMAIL_USER = CTE2.EMAIL_USER
WHERE
CTE1.EMAIL_DOMAIN <> CTE2.EMAIL_DOMAIN
ORDER BY CTE1.EMAIL_USER, CTE1.EMAIL_DOMAIN
